# 记账应用开发文档

## 1. 背景与目标
- **产品定位**：面向个人用户的极简记账工具，强调快速录入、精准分类与本地数据掌控。
- **范围约束**：当前阶段仅实现基础记账能力，不包含预算、通知、协作及云同步。
- **新增前提**：仅支持人民币账户；同步方式为纯本地离线；必须满足离线 OCR 与语音识别以及银行/第三方账单自动导入需求。

## 2. MVP 范围与排除项
- **纳入功能**
  - 账户管理（现金/银行卡/电子钱包及自定义账户）
  - 手动记账（支出、收入、转账）
  - 分类与标签体系（一级分类 + 自定义标签）
  - 自动导入银行或第三方账单（离线文件解析）
  - 基础统计（分类、时间、账户维度，图表采用 `fl_chart`）
  - 搜索与筛选（时间、账户、分类、标签、金额区间）
  - 本地备份与恢复（离线文件导出/导入）
  - 离线 OCR 与语音识别辅助录入
- **排除功能**
  - 家庭/团队共享、多终端同步、预算提醒、订阅增值服务
  - 多币种管理、云端 API 集成、推送通知

## 3. 功能模块拆解
### 3.1 账户管理
- 账户类型预置 + 用户自定义；字段：名称、类型、初始余额、排序、隐藏标识。
- 支持账户间转账，自动生成两条交易记录（支出/收入）并保持金额一致。

### 3.2 手动记账
- 交易类型：支出、收入、转账。
- 必填字段：金额（人民币）、账户、日期时间、分类。
- 可选字段：标签、商户、项目、备注、附件（图片/音频）、地理位置（可选后续扩展）。
- 支持最近记录模板复用和草稿保存。

### 3.3 分类与标签
- 提供基础分类模板，允许增删改。
- 一级分类 + 自定义标签；分类变更需同步更新关联交易（软删除标记）。
- 统计场景按分类聚合，标签用于高颗粒筛选。

### 3.4 自动导入
- 支持导入 CSV/Excel/OFX 等常见账单格式；通过文件选择或系统分享面板触发。
- 建立解析适配层：按银行模板实现转换策略，产出标准化交易模型。
- 解析冲突策略：金额或时间重复时提示用户合并、忽略或创建新记录。
- 导入过程提供预览与批量编辑能力。

### 3.5 基础统计
- 统计维度：按月/周/日聚合，分类汇总，账户余额曲线。
- 图表实现：`fl_chart` 绘制饼图、折线图、柱状图。
- 支持导出统计结果为 CSV，图表可保存为图片至本地。

### 3.6 搜索与筛选
- 支持组合条件：时间范围、账户、分类、标签、金额区间、关键词。
- 保存常用筛选条件，存储于本地以便快速调用。

### 3.7 本地备份与恢复
- 备份：导出加密 JSON/SQLite 文件至用户指定目录。
- 恢复：校验版本与数据完整性后导入，提供覆盖或合并选项。

## 4. 非功能需求
- **性能**：本地操作响应 <100ms；统计生成 <2s；批量导入 1000 条记录需在 5s 内完成。
- **可用性**：离线可用；在弱网环境下仍可调用本地功能；错误提示采用友好中文描述。
- **安全性**：交易数据存储 SQLite/Drift 表；敏感字段采用 AES 加密；备份文件需设置密码。
- **可维护性**：模块边界清晰（账户、交易、导入、统计、识别）；关键逻辑需具备单元测试覆盖。

## 5. 技术架构设计
- **整体结构**：Flutter 客户端单体应用。
  - **表示层**：Flutter UI + Material 3 极简风格；遵循无干扰配色、小半径卡片、统一留白。
  - **状态层**：使用 Riverpod（`StateNotifier` + `Provider`）驱动页面状态，结合 `freezed` 建模。
  - **数据层**：Drift 作为本地数据库；Hive/SharedPreferences 存储轻量配置；`flutter_secure_storage` 保存加密密钥。
- **模块划分**
  - `account`：账户 CRUD、余额计算。
  - `transaction`：手动录入、附件管理、校验。
  - `importer`：文件解析、字段映射、冲突处理。
  - `analytics`：统计计算、图表模型。
  - `ocr_voice`：离线 OCR、语音转文本、模板抽取。
  - `backup`：备份与恢复。
- **依赖建议**
  - Riverpod 生态：`hooks_riverpod`（提升组合能力）、`flutter_hooks`（可选）
  - 数据建模：`freezed`、`json_serializable`
  - 数据库：`drift` + `drift_dev` + `sqlite3_flutter_libs`
  - 图表：`fl_chart`
  - OCR：集成 `tesseract_ocr` 或 `google_ml_kit` 离线包（需提前下载语言包）
  - 语音识别：`speech_to_text`（支持离线资源包）或科大讯飞离线 SDK（需评估授权）
  - 文件解析：`csv`、`excel`、自定义 OFX 解析器
  - 加密：`crypto` + 平台原生 KeyStore/Keychain

## 6. 状态管理策略（Riverpod）
- 为每个核心模块定义 `StateNotifier`：如 `AccountNotifier`、`TransactionListNotifier`、`ImportWorkflowNotifier`。
- UI 层通过 `ConsumerWidget` 获取 Provider 状态，避免多余刷新。
- 使用 `AsyncValue` 表达异步导入、识别等流程；对错误统一落地到 `AppError`。
- 对跨模块数据（例如账户余额与交易列表）使用 Provider 依赖，确保更新链路清晰。
- 引入 `StateLogger`（自定义 ProviderObserver）调试状态变化。

## 7. 数据模型设计
- **账户表 (accounts)**
  - `id` (PK, string)、`name`、`type`、`initial_balance`、`current_balance`、`hidden`、`created_at`、`updated_at`
- **交易表 (transactions)**
  - `id`、`type`、`amount`、`account_id`、`paired_account_id`（转账时使用）、`category_id`、`tags`（JSON 数组）、
    `merchant`、`project`、`note`、`occurred_at`、`attachments`（路径列表）、`source`（manual/import/ocr/voice）、
    `hash`（用于去重）、`created_at`、`updated_at`
- **分类表 (categories)**
  - `id`、`name`、`icon`、`color`、`order`、`built_in`、`deleted`
- **标签表 (tags)**
  - `id`、`name`、`order`、`deleted`
- **导入模板表 (import_profiles)**
  - `id`、`name`、`bank`、`file_type`、`column_mapping`（JSON）、`date_format`、`created_at`
- **备份记录表 (backup_records)**
  - `id`、`path`、`created_at`、`note`

## 8. 自动导入流程
1. 用户选择文件 -> `importer` 模块检测格式并匹配导入模板。
2. 若无模板，进入字段映射向导，用户手动指定列与字段关系；保存为模板。
3. 解析后生成标准化交易列表，执行去重（根据金额+日期+hash）。
4. 展示预览，允许批量编辑分类、标签、账户。
5. 用户确认后批量写入数据库，并更新账户余额。

## 9. 离线 OCR 与语音识别
- **OCR 流程**：拍照 -> 图像预处理（灰度、二值化） -> OCR 识别 -> 关键字段提取（金额、日期、分类候选） -> 用户确认。
- **语音流程**：启动离线语音引擎 -> 翻译成文本 -> 基于关键字解析结构化数据（金额、分类、账户） -> 自动填充录入表单。
- **资源管理**：首次安装提示下载离线语言包；存储于应用私有目录；提供更新与删除入口。
- **隐私**：所有识别过程在本地执行，不上传音频/图片。

## 10. UI/UX 指南
- 极简视觉：亮色背景、主色采用低饱和蓝/绿，辅助色用于分类标签。
- 关键界面
  - 首页：展示当日总收支、最近交易、快速录入入口。
  - 记账页：分区输入组件，金额输入采用大号字体，分类选择使用网格。
  - 统计页：以卡片展示图表与关键指标，支持左右滑动切换维度。
- 交互准则：操作路径 <= 3 步；重要按钮置底部；语音与拍照入口固定在快捷区域。

## 11. 开发流程与工具
- **分支策略**：`main`（稳定） + `develop`（迭代） + 功能分支。
- **代码规范**：启用 `flutter format` 与 `flutter analyze`；提交前运行 `dart test`。
- **测试策略**
  - 单元测试：账户余额计算、导入解析、OCR 文本解析。
  - Widget 测试：记账页表单交互、导入流程向导。
  - Golden Test：核心页面 UI 稳定性。
- **CI 建议**：GitHub Actions（拉取代码 -> 安装依赖 -> 静态检查 -> 测试 -> 构建 APK）。

## 12. 风险与缓解
- **离线识别准确性**：需持续调优 OCR 预处理与关键字解析；提供人工校验环节。
- **账单格式多样性**：建立插件式解析器，优先覆盖主要银行，提供模板社区导入接口。
- **数据安全**：加密密钥泄露风险 -> 使用系统 KeyStore/Keychain，增设密码校验。
- **性能压力**：批量导入大文件时内存占用高 -> 分批解析、流式写入数据库。

## 13. 里程碑建议
1. **迭代 1**：项目骨架、账户管理、手动记账、分类体系、本地存储。
2. **迭代 2**：基础统计与图表、搜索筛选、备份恢复。
3. **迭代 3**：自动导入框架、CSV 模板支持、去重策略。
4. **迭代 4**：离线 OCR & 语音识别集成、识别流程优化。
